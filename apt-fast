#!/bin/bash
# apt-fast v1.6 by Matt Parnell http://www.mattparnell.com, GNU GPLv3
# Use this just like aptitude or apt-get for faster package downloading.
# Modified by Waldemar {BOB}{Burnfaker} Wetzel
###################################################################
# DO NOT EDIT BELOW THIS LINE UNLESS YOU KNOW WHAT YOU ARE DOING!
###################################################################

# Config File
source /etc/apt-fast.conf

#Define lockfile / download directory / filelist for download manager / apt cache directory
LCK_FILE=/var/run/$(basename $0).lock
DLDIR=/var/cache/apt/archives/apt-fast
DLLIST=/tmp/apt-fast.list
APTCACHE=/var/cache/apt/archives


# Check for proper priveliges
[ "`whoami`" = root ] || exec sudo "$0" "$@"

# Check if a lockfile exists
[ -f $LCK_FILE ] && { echo "$(basename $0) already running"; exit 1; }

# Remove lockfile
LCK_RM() {
rm -f $LCK_FILE
#echo lock-File $LCK_FILE deleted
}

trap "LCK_RM ; exit 1" 2 9 15

# Create and insert a PID number to lockfile 
echo $$ > $LCK_FILE
NUM=1

# Make sure one of the download managers is enabled
[ -z "$_DOWNLOADER" ] && echo "You must configure /etc/apt-fast.conf to use axel or aria2c" && LCK_RM && exit 1

# If the user entered arguments contain upgrade, install, or dist-upgrade
if echo "$@" | grep -q "upgrade\|install\|dist-upgrade|full-upgrade"; then
  echo "Working...";

  # Test if apt-fast directory is present where we put packages
  if [ ! -d $DLDIR ] ; then
  	mkdir $DLDIR;
 fi

 cd $DLDIR;

 # Get the package URL's
  # note aptitude doesn't have this functionality
  # so we use apt-get only
  apt-get -y --print-uris $@ | egrep -o -e "(ht|f)tp://[^\']+" > "$DLLIST"


# Test /tmp/apt-fast.list file exists AND not zero bytes 
# download all files from the list
# if file is empty don't start download manager
if [ -s "$DLLIST" ]; then
  eval ${_DOWNLOADER}
fi


# check the 
if [ $(find $DLDIR -mtime -1|wc -l) -gt 1 ];
    then
  # Move all packages to the apt install directory by force to ensure 
  # already existing debs which may be incomplete are replaced
  mv -f *.deb $APTCACHE;
fi

  # Install our downloaded packages
  ${_APTMGR} $@;

  echo -e "\nDone! Verify that all packages were installed successfully. If errors are found, run apt-get clean as root and try again using apt-get directly.\n";

else
   ${_APTMGR} $@;
fi

# Downtime befor remove the lockfile
while [ $NUM -le 2 ] ; do
	NUM=`expr $NUM + 1`	
	sleep 1
done

# After error or all done remove our lockfile with a PID number
LCK_RM
exit 0;
